name: Release ÂµCAS Container
run-name: Release ÂµCAS Container ${{ inputs.version }}
on:
  # Trigger on new releases
  release:
    types: [published]
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 13.6.2)'
        required: false
        default: ''
      push_to_registry:
        description: 'Push to container registry'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  MAVEN_OPTS: '-Xmx1024m'
  REGISTRY: ghcr.io
  IMAGE_NAME: aero.minova.mcas

jobs:
  release-docker:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
            
      - name: Log in to Container Registry
        if: github.event.inputs.push_to_registry != 'false'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configure Git
        run: |
          git config --global user.email "service@minova.com"
          git config --global user.name "minova-worker"
          
      - name: Determine version and image tags
        env:
          MAIN_GITHUB_RELEASE_USERNAME: ${{ secrets.MAIN_GITHUB_RELEASE_USERNAME }}
          MAIN_GITHUB_RELEASE_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
          GITHUB_ACCESS_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
        id: meta
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            # Remove 'v' prefix if present
            VERSION=${VERSION#v}
          else
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout -pl mcas -Dusername=$GITHUB_ACCESS_TOKEN -Dpassword=$GITHUB_ACCESS_TOKEN --settings .github/settings.xml)
          fi
          
          # Set environment variables
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Determine image tags
          FULL_IMAGE_NAME="${{ env.REGISTRY }}/minova-afis/${{ env.IMAGE_NAME }}"
          
          if [[ "$VERSION" == *"SNAPSHOT"* ]]; then
            TAGS="$FULL_IMAGE_NAME:snapshot,$FULL_IMAGE_NAME:latest-snapshot"
            echo "SNAPSHOT=true" >> $GITHUB_ENV
          else
            TAGS="$FULL_IMAGE_NAME:$VERSION,$FULL_IMAGE_NAME:latest"
            echo "SNAPSHOT=false" >> $GITHUB_ENV
          fi
          
          echo "TAGS=$TAGS" >> $GITHUB_ENV
          echo "FULL_IMAGE_NAME=$FULL_IMAGE_NAME" >> $GITHUB_ENV
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "full_image_name=$FULL_IMAGE_NAME" >> $GITHUB_OUTPUT
          
          echo "Release version: $VERSION"
          echo "Image tags: $TAGS"
          
      - name: Update version in pom.xml
        env:
          MAIN_GITHUB_RELEASE_USERNAME: ${{ secrets.MAIN_GITHUB_RELEASE_USERNAME }}
          MAIN_GITHUB_RELEASE_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
          GITHUB_ACCESS_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
        if: ${{ env.SNAPSHOT == 'false' }}
        run: |
          # Update version in mcas module
          mvn versions:set -DnewVersion=${{ env.VERSION }} -pl mcas \
                      -Dusername=$GITHUB_ACCESS_TOKEN \
                      -Dpassword=$GITHUB_ACCESS_TOKEN \
                      --settings .github/settings.xml
          mvn versions:commit -pl mcas \
                      -Dusername=$GITHUB_ACCESS_TOKEN \
                      -Dpassword=$GITHUB_ACCESS_TOKEN \
                      --settings .github/settings.xml
          
      - name: Build and push Docker image
        env:
          MAIN_GITHUB_RELEASE_USERNAME: ${{ secrets.MAIN_GITHUB_RELEASE_USERNAME }}
          MAIN_GITHUB_RELEASE_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
          GITHUB_ACCESS_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
        run: |
          echo "Building ÂµCAS Docker container..."

          # First, build dependencies without running Jib
          echo "Building dependencies..."
          mvn clean install -pl mcas -am -DskipTests -B \
            -Dusername=$GITHUB_ACCESS_TOKEN \
            -Dpassword=$GITHUB_ACCESS_TOKEN \
            --settings .github/settings.xml

          # Extract just the tag names (e.g., "1.0.0,latest") from full image references
          IFS=',' read -ra TAG_ARRAY <<< "${{ env.TAGS }}"
          JIB_TAGS=""
          for full_tag in "${TAG_ARRAY[@]}"; do
            # Extract just the tag part after the last colon
            tag_name="${full_tag##*:}"
            if [ -z "$JIB_TAGS" ]; then
              JIB_TAGS="$tag_name"
            else
              JIB_TAGS="$JIB_TAGS,$tag_name"
            fi
          done

          echo "Image: ${{ env.FULL_IMAGE_NAME }}"
          echo "Tags: $JIB_TAGS"

          if [ "${{ github.event.inputs.push_to_registry }}" == "false" ]; then
            echo "Building image locally only (not pushing to registry)..."
            mvn com.google.cloud.tools:jib-maven-plugin:3.4.0:dockerBuild -pl mcas -B \
              -Dusername=$GITHUB_ACCESS_TOKEN \
              -Dpassword=$GITHUB_ACCESS_TOKEN \
              --settings .github/settings.xml \
              -Djib.to.image="${{ env.FULL_IMAGE_NAME }}" \
              -Djib.to.tags=local \
              -Djib.container.mainClass=aero.minova.cas.CoreApplicationSystemApplication
          else
            echo "Building and pushing image to registry..."
            mvn com.google.cloud.tools:jib-maven-plugin:3.4.0:build -pl mcas -B \
              -Dusername=$GITHUB_ACCESS_TOKEN \
              -Dpassword=$GITHUB_ACCESS_TOKEN \
              --settings .github/settings.xml \
              -Djib.to.image="${{ env.FULL_IMAGE_NAME }}" \
              -Djib.to.tags="$JIB_TAGS" \
              -Djib.container.mainClass=aero.minova.cas.CoreApplicationSystemApplication
          fi
          
      - name: Test Docker image
        if: github.event.inputs.push_to_registry == 'false'
        run: |
          echo "Testing locally built Docker image..."
          
          # Run container in background with health check
          docker run -d --name mcas-test \
            -p 8084:8084 \
            -e "spring.datasource.url=jdbc:h2:mem:testdb" \
            -e "spring.datasource.username=sa" \
            -e "spring.datasource.password=" \
            -e "spring.datasource.driverClassName=org.h2.Driver" \
            -e "login_dataSource=admin" \
            "${{ env.FULL_IMAGE_NAME }}:local"
          
          # Wait for container to start
          sleep 30
          
          # Check if container is running
          if docker ps | grep mcas-test; then
            echo "âœ… Container started successfully"
            
            # Try to access health endpoint (if available)
            if curl -f http://localhost:8084/cas/actuator/health 2>/dev/null; then
              echo "âœ… Health endpoint accessible"
            else
              echo "â„¹ï¸ Health endpoint not accessible (may be disabled)"
            fi

      - name: Create and push Git tag
        if: ${{ env.SNAPSHOT == 'false' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="mcas_container_${{ env.VERSION }}"
          echo "Creating tag: $TAG_NAME"
          
          # Create and push the tag
          git tag -a "$TAG_NAME" -m "ÂµCAS Release ${{ env.VERSION }}"
          git push origin "$TAG_NAME"
          
          echo "âœ… Created and pushed tag: $TAG_NAME"
          else
            echo "âŒ Container failed to start"
            docker logs mcas-test
            exit 1
          fi
          
          # Cleanup
          docker stop mcas-test
          docker rm mcas-test
          
      - name: Create deployment summary
        run: |
          echo "## ÂµCAS Docker Container Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Name**: ${{ env.FULL_IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: ${{ env.TAGS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.push_to_registry }}" == "false" ]; then
            echo "ðŸ—ï¸ **Built locally only** (not pushed to registry)" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš€ **Pushed to registry** and ready for deployment" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Container Usage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull and run the container:" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 8084:8084 -p 8081:8081 \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e \"spring.datasource.url=jdbc:sqlserver://YOUR_SERVER:1433;databaseName=YOUR_DB\" \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e \"spring.datasource.username=YOUR_USER\" \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e \"spring.datasource.password=YOUR_PASSWORD\" \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.FULL_IMAGE_NAME }}:${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
