name: Release µCAS Service
run-name: Release µCAS ${{ inputs.artifact_type || 'both' }} ${{ inputs.version }}
on:
  # Trigger on new releases
  release:
    types: [published]

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 1.0.0)'
        required: false
        default: ''
      artifact_type:
        description: 'What to build and release'
        required: false
        default: 'both'
        type: choice
        options:
        - 'both'
        - 'fat-jar'
        - 'container'

env:
  MAVEN_OPTS: '-Xmx1024m'
  REGISTRY: ghcr.io
  IMAGE_NAME: aero.minova.mcas

jobs:
  release-mcas:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
            
      - name: Configure Git
        run: |
          git config --global user.email "service@minova.com"
          git config --global user.name "minova-worker"
          
      - name: Determine version
        env:
          MAIN_GITHUB_RELEASE_USERNAME: ${{ secrets.MAIN_GITHUB_RELEASE_USERNAME }}
          MAIN_GITHUB_RELEASE_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
          GITHUB_ACCESS_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            # Remove 'v' prefix if present
            VERSION=${VERSION#v}
          else
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout -Dusername=$GITHUB_ACCESS_TOKEN -Dpassword=$GITHUB_ACCESS_TOKEN --settings .github/settings.xml)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Determine what to build
        id: build_flags
        run: |
          ARTIFACT_TYPE="${{ github.event.inputs.artifact_type }}"
          # Default to 'both' if not specified (e.g., on release event)
          if [ -z "$ARTIFACT_TYPE" ]; then
            ARTIFACT_TYPE="both"
          fi

          echo "ARTIFACT_TYPE=$ARTIFACT_TYPE" >> $GITHUB_ENV

          # Set build flags
          if [ "$ARTIFACT_TYPE" = "both" ] || [ "$ARTIFACT_TYPE" = "fat-jar" ]; then
            echo "BUILD_FATJAR=true" >> $GITHUB_ENV
            echo "build_fatjar=true" >> $GITHUB_OUTPUT
          else
            echo "BUILD_FATJAR=false" >> $GITHUB_ENV
            echo "build_fatjar=false" >> $GITHUB_OUTPUT
          fi

          if [ "$ARTIFACT_TYPE" = "both" ] || [ "$ARTIFACT_TYPE" = "container" ]; then
            echo "BUILD_CONTAINER=true" >> $GITHUB_ENV
            echo "build_container=true" >> $GITHUB_OUTPUT
          else
            echo "BUILD_CONTAINER=false" >> $GITHUB_ENV
            echo "build_container=false" >> $GITHUB_OUTPUT
          fi

          echo "Building: $ARTIFACT_TYPE"
          echo "  - Fat-JAR: ${BUILD_FATJAR:-false}"
          echo "  - Container: ${BUILD_CONTAINER:-false}"

      - name: Update version in pom.xml
        env:
          MAIN_GITHUB_RELEASE_USERNAME: ${{ secrets.MAIN_GITHUB_RELEASE_USERNAME }}
          MAIN_GITHUB_RELEASE_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
        if: ${{ !contains(env.VERSION, 'SNAPSHOT') }}
        run: |
          # Update version in mcas module
          mvn versions:set -DnewVersion=${{ env.VERSION }} -pl mcas \
                      --settings .github/settings.xml
          mvn versions:commit -pl mcas \
                      --settings .github/settings.xml
          
      - name: Build and install µCAS fat-jar
        env:
          MAIN_GITHUB_RELEASE_USERNAME: ${{ secrets.MAIN_GITHUB_RELEASE_USERNAME }}
          MAIN_GITHUB_RELEASE_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
        run: |
          echo "Building µCAS fat-jar and installing dependencies..."
          mvn clean install -pl mcas -am -B -DskipTests \
                      --settings .github/settings.xml
          
      - name: Deploy to GitHub Packages
        if: env.BUILD_FATJAR == 'true'
        env:
          MAIN_GITHUB_RELEASE_USERNAME: ${{ secrets.MAIN_GITHUB_RELEASE_USERNAME }}
          MAIN_GITHUB_RELEASE_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
        run: |
          echo "Deploying µCAS fat-jar to GitHub Packages..."
          mvn deploy -pl mcas -B -DskipTests \
                      --settings .github/settings.xml

      - name: Upload fat-jar as release asset
        if: github.event_name == 'release' && env.BUILD_FATJAR == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: mcas/target/aero.minova.service.mcas.jar
          asset_name: aero.minova.service.mcas-${{ env.VERSION }}.jar
          asset_content_type: application/java-archive

      - name: Build and push container with Jib
        if: env.BUILD_CONTAINER == 'true'
        env:
          MAIN_GITHUB_RELEASE_USERNAME: ${{ secrets.MAIN_GITHUB_RELEASE_USERNAME }}
          MAIN_GITHUB_RELEASE_TOKEN: ${{ secrets.MAIN_GITHUB_RELEASE_TOKEN }}
        run: |
          echo "Building and pushing µCAS container with Jib..."

          # Determine image tags
          FULL_IMAGE_NAME="${{ env.REGISTRY }}/minova-afis/${{ env.IMAGE_NAME }}"

          if [[ "${{ env.VERSION }}" == *"SNAPSHOT"* ]]; then
            TAGS="snapshot,latest-snapshot"
          else
            TAGS="${{ env.VERSION }},latest"
          fi

          echo "Image: $FULL_IMAGE_NAME"
          echo "Tags: $TAGS"

          # Run Jib on mcas module only
          # Environment variables provide GitHub Packages authentication via settings.xml
          # Maven Central remains unauthenticated (as it should be)
          mvn com.google.cloud.tools:jib-maven-plugin:3.4.0:build -pl mcas -B \
            --settings .github/settings.xml \
            -Djib.to.image="$FULL_IMAGE_NAME" \
            -Djib.to.tags="$TAGS" \
            -Djib.to.auth.username="${{ github.actor }}" \
            -Djib.to.auth.password="${{ secrets.GITHUB_TOKEN }}"

      - name: Create and push Git tag
        if: ${{ !contains(env.VERSION, 'SNAPSHOT') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create appropriate tag based on what was built
          if [ "${{ env.ARTIFACT_TYPE }}" = "both" ]; then
            TAG_NAME="mcas_${{ env.VERSION }}"
            TAG_MESSAGE="µCAS Release ${{ env.VERSION }} (fat-jar + container)"
          elif [ "${{ env.ARTIFACT_TYPE }}" = "fat-jar" ]; then
            TAG_NAME="mcas_fatjar_${{ env.VERSION }}"
            TAG_MESSAGE="µCAS Fat-JAR Release ${{ env.VERSION }}"
          elif [ "${{ env.ARTIFACT_TYPE }}" = "container" ]; then
            TAG_NAME="mcas_container_${{ env.VERSION }}"
            TAG_MESSAGE="µCAS Container Release ${{ env.VERSION }}"
          fi

          echo "Creating tag: $TAG_NAME"

          # Create and push the tag
          git tag -a "$TAG_NAME" -m "$TAG_MESSAGE"
          git push origin "$TAG_NAME"

          echo "✅ Created and pushed tag: $TAG_NAME"

      - name: Create artifact summary
        run: |
          echo "## µCAS Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact Type**: ${{ env.ARTIFACT_TYPE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Fat-JAR summary
          if [ "${{ env.BUILD_FATJAR }}" = "true" ]; then
            echo "### Fat-JAR" >> $GITHUB_STEP_SUMMARY
            echo "- **Group ID**: aero.minova" >> $GITHUB_STEP_SUMMARY
            echo "- **Artifact ID**: service.mcas" >> $GITHUB_STEP_SUMMARY
            echo "- **Repository**: https://maven.pkg.github.com/minova-afis/aero.minova.maven.root" >> $GITHUB_STEP_SUMMARY

            if [ -f mcas/target/aero.minova.service.mcas.jar ]; then
              JAR_SIZE=$(ls -lh mcas/target/aero.minova.service.mcas.jar | awk '{print $5}')
              echo "- **Size**: $JAR_SIZE" >> $GITHUB_STEP_SUMMARY
              echo "- **Status**: ✅ Successfully built and deployed" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Status**: ❌ Build failed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Container summary
          if [ "${{ env.BUILD_CONTAINER }}" = "true" ]; then
            echo "### Container" >> $GITHUB_STEP_SUMMARY
            echo "- **Registry**: ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Image**: ${{ env.REGISTRY }}/minova-afis/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY

            if [[ "${{ env.VERSION }}" == *"SNAPSHOT"* ]]; then
              echo "- **Tags**: \`snapshot\`, \`latest-snapshot\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Tags**: \`${{ env.VERSION }}\`, \`latest\`" >> $GITHUB_STEP_SUMMARY
            fi

            echo "- **Status**: ✅ Successfully built and pushed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pull and run:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/minova-afis/${{ env.IMAGE_NAME }}:${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
            echo "docker run -p 8084:8084 -p 8081:8081 \\" >> $GITHUB_STEP_SUMMARY
            echo "  -e \"spring.datasource.url=jdbc:sqlserver://YOUR_SERVER:1433;databaseName=YOUR_DB\" \\" >> $GITHUB_STEP_SUMMARY
            echo "  -e \"spring.datasource.username=YOUR_USER\" \\" >> $GITHUB_STEP_SUMMARY
            echo "  -e \"spring.datasource.password=YOUR_PASSWORD\" \\" >> $GITHUB_STEP_SUMMARY
            echo "  ${{ env.REGISTRY }}/minova-afis/${{ env.IMAGE_NAME }}:${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi